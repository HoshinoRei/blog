<!doctype html><html lang=zh-cn><head><title>Debian 软路由 + 华硕AX86U 实现多个 WiFi VLAN 隔离 ::
星野玲的博客</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="小玲有这样一个需求，一个无线路由器能发出多个 SSID 的 WiFi，并且连接一个 SSID 的 WiFi 的设备与连接另一个 SSID 的 WiFi 的设备之间的通信可以隔离。这里的隔离不是"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://blog.bling.moe/post/7/><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://blog.bling.moe/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://blog.bling.moe/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://blog.bling.moe/img/favicon.png><link href=/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="Debian 软路由 + 华硕AX86U 实现多个 WiFi VLAN 隔离"><meta name=twitter:description content="小玲有这样一个需求，一个无线路由器能发出多个 SSID 的 WiFi，并且连接一个 SSID 的 WiFi 的设备与连接另一个 SSID 的 WiFi 的设备之间的通信可以隔离。这里的隔离不是“禁止无线用户互通”，而是要 VLAN 隔离。"><meta property="og:title" content="Debian 软路由 + 华硕AX86U 实现多个 WiFi VLAN 隔离"><meta property="og:description" content="小玲有这样一个需求，一个无线路由器能发出多个 SSID 的 WiFi，并且连接一个 SSID 的 WiFi 的设备与连接另一个 SSID 的 WiFi 的设备之间的通信可以隔离。这里的隔离不是“禁止无线用户互通”，而是要 VLAN 隔离。"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.bling.moe/post/7/"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-08-10T13:29:00+08:00"><meta property="article:modified_time" content="2024-08-26T07:58:22+08:00"><meta property="og:site_name" content="星野玲的博客"></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>星野玲的博客</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/index.xml>RSS</a></li><li><a href=/about/>关于</a></li><li><a href=/links/>友链</a></li><ul class=menu__sub-inner><li class=menu__sub-inner-more-trigger>查看更多
<span class=menu__sub-inner-more-trigger-icon><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span></li><ul class="menu__sub-inner-more hidden"><li><a href=https://digital-garden.bling.moe>数字花园</a></li></ul></ul></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/index.xml>RSS</a></li><li><a href=/about/>关于</a></li><li><a href=/links/>友链</a></li><li><a href=https://digital-garden.bling.moe>数字花园</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><article class=post><h1 class=post-title>Debian 软路由 + 华硕AX86U 实现多个 WiFi VLAN 隔离</h1><div class=post-meta><time class=post-date>2022-08-10</time>
<span class=post-moddate>(最后修改于：
2024-08-26)</span>
<span class=post-author>— 作者： 星野玲</span></div><span class=post-tags><a href=https://blog.bling.moe/tags/debian/>#Debian</a>&nbsp;
<a href=https://blog.bling.moe/tags/%E5%8D%8E%E7%A1%95ax86u/>#华硕AX86U</a>&nbsp;
<a href=https://blog.bling.moe/tags/%E8%B7%AF%E7%94%B1%E5%99%A8/>#路由器</a>&nbsp;
<a href=https://blog.bling.moe/tags/%E8%BD%AF%E8%B7%AF%E7%94%B1/>#软路由</a>&nbsp;</span><div class=post-content><p>小玲有这样一个需求，一个无线路由器能发出多个 SSID 的 WiFi，并且连接一个 SSID 的 WiFi 的设备与连接另一个 SSID 的 WiFi 的设备之间的通信可以隔离。这里的隔离不是“禁止无线用户互通”，而是要 VLAN 隔离。</p><p>这样的好处是比如家里来了客人的话，可以让客人连接上客人专用的 WiFi。因为客人用的 WiFi 与小玲专用的 WiFi 之间是 VLAN 隔离的，客人就无法访问到小玲的局域网里的 NAS 之类的设备。或者小玲有一些智能家居设备，把这些智能家居设备放进一个局域网里，然后与小玲专用的局域网之间隔离，可以防止一些潜在的隐私窥探问题。</p><p>以前小玲用过一个能刷集客 AP 固件的路由器，集客 AP 固件可以在一个路由器里创建多个 SSID，并且还能设置 VLAN ID。不过现在没见过能刷集客 AP 固件的 WiFi 6 路由器了。好在小玲买的 AX86U 能通过一个野路子实现小玲的需求。小玲很庆幸买对了路由器，要是买了 TP-Link 估计就要跟这个功能说拜拜了。</p><h2 id=设备介绍>设备介绍
<a href=#%e8%ae%be%e5%a4%87%e4%bb%8b%e7%bb%8d class=h-anchor aria-hidden=true>#</a></h2><p>首先，先介绍一下要使用的设备。R4S 是小玲目前在用的软路由，刷了 Armbian 系统，它的设置请看 <a href=https://blog.bling.moe/post/3/>这篇文章</a>。<a href=https://blog.bling.moe/post/6/>AX86U</a> 刷了梅林固件，小玲不清楚原版固件能不能实现这个功能，如果不能请像小玲一样刷梅林固件。</p><h2 id=网段规划>网段规划
<a href=#%e7%bd%91%e6%ae%b5%e8%a7%84%e5%88%92 class=h-anchor aria-hidden=true>#</a></h2><p>然后规划一下网段。小玲原本在 R4S 里给整个局域网设置的 IPv4 网段为 <code>192.168.3.0/24</code>。小玲决定把它拆分成 4 个子网。它们分别如下。</p><table><thead><tr><th style=text-align:center>网段</th><th style=text-align:center>第一个可用地址</th><th style=text-align:center>最后一个可用地址</th><th style=text-align:center>用途</th></tr></thead><tbody><tr><td style=text-align:center><code>192.168.3.0/26</code></td><td style=text-align:center><code>192.168.3.1</code></td><td style=text-align:center><code>192.168.3.62</code></td><td style=text-align:center>小玲专用的局域网</td></tr><tr><td style=text-align:center><code>192.168.3.64/26</code></td><td style=text-align:center><code>192.168.3.65</code></td><td style=text-align:center><code>192.168.3.126</code></td><td style=text-align:center>家人专用的局域网</td></tr><tr><td style=text-align:center><code>192.168.3.128/26</code></td><td style=text-align:center><code>192.168.3.129</code></td><td style=text-align:center><code>192.168.3.190</code></td><td style=text-align:center>访客专用的局域网</td></tr><tr><td style=text-align:center><code>192.168.3.192/26</code></td><td style=text-align:center><code>192.168.3.193</code></td><td style=text-align:center><code>192.168.3.254</code></td><td style=text-align:center>智能家居专用的局域网</td></tr></tbody></table><p>上面每个子网的可用 IP 数都是 62，这个数量对小玲来说够用了。</p><p>小玲用的宽带只能获取到一个 IPv6 的 <code>/64</code> 前缀，小玲打算将这个前缀用于小玲专用的局域网。另外 3 个局域网就无法使用公网 IPv6 地址了。虽然没有公网 IPv6 地址，但是小玲还可以设置 ULA<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>，然后通过 NAT，让另外 3 个局域网获得访问 IPv6 地址的能力。使用这个 <a href=https://cd34.com/rfc4193/>网站</a> 可以生成一个 ULA 的网段，小玲生成的网段是 <code>fddd:afcf::/48</code>，小玲决定拿出这里面的前 3 个 <code>/64</code> 网段来分别给另外 3 个局域网使用。为什么要用 <code>/64</code> 这么大的网段呢？因为比 <code>/64</code> 更小的网段就无法通过 SLAAC 分配 IP 地址，也就是说安卓设备无法被分配到这个网段的 IP 地址了。<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup></p><table><thead><tr><th style=text-align:center>ULA 网段</th><th style=text-align:center>用途</th></tr></thead><tbody><tr><td style=text-align:center>不需要</td><td style=text-align:center>小玲专用的局域网</td></tr><tr><td style=text-align:center><code>fddd:afcf::/64</code></td><td style=text-align:center>家人专用的局域网</td></tr><tr><td style=text-align:center><code>fddd:afcf:0:1::/64</code></td><td style=text-align:center>访客专用的局域网</td></tr><tr><td style=text-align:center><code>fddd:afcf:0:2::/64</code></td><td style=text-align:center>智能家居专用的局域网</td></tr></tbody></table><p>每个网段在 R4S 里的地址都被小玲指定为了第一个可用地址，也就是说，R4S 现在拥有 4 个局域网的 IPv4 地址，3 个局域网的 IPv6 地址，它们分别如下。</p><ul><li>192.168.3.1</li><li>192.168.3.65</li><li>192.168.3.129</li><li>192.168.3.193</li><li>fddd:afcf::</li><li>fddd:afcf:0:1::</li><li>fddd:afcf:0:2::</li></ul><h2 id=vlan-id-规划>VLAN ID 规划
<a href=#vlan-id-%e8%a7%84%e5%88%92 class=h-anchor aria-hidden=true>#</a></h2><p>网段规划完了，现在要规划 VLAN ID，VLAN ID 不仅在 R4S 里用到 AX86U 里也要用到。</p><table><thead><tr><th style=text-align:center>VLAN ID</th><th style=text-align:center>用途</th></tr></thead><tbody><tr><td style=text-align:center>无</td><td style=text-align:center>小玲专用的局域网</td></tr><tr><td style=text-align:center>10</td><td style=text-align:center>家人专用的局域网</td></tr><tr><td style=text-align:center>20</td><td style=text-align:center>访客专用的局域网</td></tr><tr><td style=text-align:center>30</td><td style=text-align:center>智能家居专用的局域网</td></tr></tbody></table><h2 id=网桥规划>网桥规划
<a href=#%e7%bd%91%e6%a1%a5%e8%a7%84%e5%88%92 class=h-anchor aria-hidden=true>#</a></h2><p>默认情况下，AX86U 里只有一个网桥，名字叫 <code>br0</code>。<code>br0</code> 网桥的成员默认就是所有的接口。小玲因为有 4 个局域网，所以需要 4 个网桥。网桥的名称可以自定义，这里小玲就用 <code>br1</code>、<code>br2</code> 等作为网桥名吧。</p><table><thead><tr><th style=text-align:center>网桥</th><th style=text-align:center>用途</th></tr></thead><tbody><tr><td style=text-align:center><code>br0</code></td><td style=text-align:center>小玲专用的局域网</td></tr><tr><td style=text-align:center><code>br1</code></td><td style=text-align:center>家人专用的局域网</td></tr><tr><td style=text-align:center><code>br2</code></td><td style=text-align:center>访客专用的局域网</td></tr><tr><td style=text-align:center><code>br3</code></td><td style=text-align:center>智能家居专用的局域网</td></tr></tbody></table><h2 id=设置网段与-vlan-id>设置网段与 VLAN ID
<a href=#%e8%ae%be%e7%bd%ae%e7%bd%91%e6%ae%b5%e4%b8%8e-vlan-id class=h-anchor aria-hidden=true>#</a></h2><p>网段和 VLAN ID 规划好后，现在就需要在 R4S 里设置网段和 VLAN ID 了。</p><p>在 R4S 里编辑 <code>/etc/network/interfaces</code>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo vim /etc/network/interfaces
</span></span></code></pre></div><p>R4S 的 LAN 口的接口名称是 <code>enp1s0</code>，在 <code>enp1s0</code> 后面加上一个 <code>.&lt;数字></code> 表示这个接口是一个以这个数字为 VLAN ID 的接口。例如 <code>enp1s0.10</code> 这个接口的 VLAN ID 是 <code>10</code>，<code>enp1s0.20</code> 这个接口的 VLAN ID 是 <code>20</code>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>auto enp1s0
</span></span><span style=display:flex><span>allow-hotplug enp1s0
</span></span><span style=display:flex><span>iface enp1s0 inet static
</span></span><span style=display:flex><span>    address 192.168.3.1/26
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>auto enp1s0.10
</span></span><span style=display:flex><span>allow-hotplug enp1s0.10
</span></span><span style=display:flex><span>iface enp1s0.10 inet static
</span></span><span style=display:flex><span>    address 192.168.3.65/26
</span></span><span style=display:flex><span>iface enp1s0.10 inet6 static
</span></span><span style=display:flex><span>    address fddd:afcf::/64
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>auto enp1s0.20
</span></span><span style=display:flex><span>allow-hotplug enp1s0.20
</span></span><span style=display:flex><span>iface enp1s0.20 inet static
</span></span><span style=display:flex><span>    address 192.168.3.129/26
</span></span><span style=display:flex><span>iface enp1s0.20 inet6 static
</span></span><span style=display:flex><span>    address fddd:afcf:0:1::/64
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>auto enp1s0.30
</span></span><span style=display:flex><span>allow-hotplug enp1s0.30
</span></span><span style=display:flex><span>iface enp1s0.30 inet static
</span></span><span style=display:flex><span>    address 192.168.3.193/26
</span></span><span style=display:flex><span>iface enp1s0.30 inet6 static
</span></span><span style=display:flex><span>    address fddd:afcf:0:2::/64
</span></span></code></pre></div><h2 id=设置-dnsmasq>设置 Dnsmasq
<a href=#%e8%ae%be%e7%bd%ae-dnsmasq class=h-anchor aria-hidden=true>#</a></h2><p>还需要设置 Dnsmasq 以给每个网段的设备自动分配 IP 地址。小玲使用的 Dnsmasq 是通过 <a href=https://blog.bling.moe/post/3/>这篇文章</a> 里安装的 Dnsmasq。</p><p>在 R4S 里编辑 <code>dnsmasq.conf</code>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vim ~/config/dnsmasq/dnsmasq.conf
</span></span></code></pre></div><p>下面的内容已省略无关配置。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span># 监听这 4 个接口
</span></span><span style=display:flex><span>interface=enp1s0
</span></span><span style=display:flex><span>interface=enp1s0.10
</span></span><span style=display:flex><span>interface=enp1s0.20
</span></span><span style=display:flex><span>interface=enp1s0.30
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dhcp-range=interface:enp1s0,192.168.3.2,192.168.3.62,1h
</span></span><span style=display:flex><span>dhcp-range=interface:enp1s0,::,constructor:enp1s0,ra-stateless,1h
</span></span><span style=display:flex><span>dhcp-option=interface:enp1s0,option:router,192.168.3.1
</span></span><span style=display:flex><span>dhcp-option=interface:enp1s0,option:dns-server,192.168.3.1 
</span></span><span style=display:flex><span># 这里的 fe80::362f:579d:8c86:105b 请换成你的本地链路地址
</span></span><span style=display:flex><span>dhcp-option=interface:enp1s0,option6:dns-server,[fe80::362f:579d:8c86:105b]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dhcp-range=interface:enp1s0.10,192.168.3.66,192.168.3.126,1h
</span></span><span style=display:flex><span>dhcp-range=interface:enp1s0.10,::,constructor:enp1s0.10,ra-stateless,1h
</span></span><span style=display:flex><span>dhcp-option=interface:enp1s0.10,option:router,192.168.3.65
</span></span><span style=display:flex><span>dhcp-option=interface:enp1s0.10,option:dns-server,192.168.3.65
</span></span><span style=display:flex><span>dhcp-option=interface:enp1s0.10,option6:dns-server,[fddd:afcf::]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dhcp-range=interface:enp1s0.20,192.168.3.130,192.168.3.190,1h
</span></span><span style=display:flex><span>dhcp-range=interface:enp1s0.20,::,constructor:enp1s0.20,ra-stateless,1h
</span></span><span style=display:flex><span>dhcp-option=interface:enp1s0.20,option:router,192.168.3.129
</span></span><span style=display:flex><span>dhcp-option=interface:enp1s0.20,option:dns-server,192.168.3.129
</span></span><span style=display:flex><span>dhcp-option=interface:enp1s0.20,option6:dns-server,[fddd:afcf:0:1::]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dhcp-range=interface:enp1s0.30,192.168.3.194,192.168.3.254,1h
</span></span><span style=display:flex><span>dhcp-range=interface:enp1s0.30,::,constructor:enp1s0.30,ra-stateless,1h
</span></span><span style=display:flex><span>dhcp-option=interface:enp1s0.30,option:router,192.168.3.193
</span></span><span style=display:flex><span>dhcp-option=interface:enp1s0.30,option:dns-server,192.168.3.193
</span></span><span style=display:flex><span>dhcp-option=interface:enp1s0.30,option6:dns-server,[fddd:afcf:0:2::]
</span></span></code></pre></div><h2 id=设置-wifi>设置 WiFi
<a href=#%e8%ae%be%e7%bd%ae-wifi class=h-anchor aria-hidden=true>#</a></h2><p>设置完 R4S，接下来就要设置 AX86U 了。先在 AX86U 里设置 WiFi。小玲专用的 WiFi 就在 <code>无线网络</code> 里设置，家人专用的 WiFi、访客专用的 WiFi、智能家居专用的 WiFi 在 <code>访客网络</code> 里设置。同时请把 AX86U 的操作模式设为 <code>无线接入点（AP）模式</code>。</p><p>在这里有一个问题需要弄明白，那就是在 AX86U 的系统里，网络接口是以 <code>eth0</code>、<code>eth1</code> 这样的字符串表示的。咱们需要知道哪个网口和哪个 WiFi 对应哪个接口。好在小玲找到一份对应关系。<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup> 不过这个对应关系不包含访客网络的接口。小玲又自己测试了一下，整理出了以下的对应关系。</p><table><thead><tr><th style=text-align:center>物理网口或 WLAN 接口</th><th style=text-align:center>系统内的接口名称</th></tr></thead><tbody><tr><td style=text-align:center>WAN</td><td style=text-align:center><code>eth0</code></td></tr><tr><td style=text-align:center>LAN4</td><td style=text-align:center><code>eth1</code></td></tr><tr><td style=text-align:center>LAN3</td><td style=text-align:center><code>eth2</code></td></tr><tr><td style=text-align:center>LAN2</td><td style=text-align:center><code>eth3</code></td></tr><tr><td style=text-align:center>LAN1</td><td style=text-align:center><code>eth4</code></td></tr><tr><td style=text-align:center>2.5G LAN</td><td style=text-align:center><code>eth5</code></td></tr><tr><td style=text-align:center>2.4GHz WLAN</td><td style=text-align:center><code>eth6</code></td></tr><tr><td style=text-align:center>5GHz WLAN</td><td style=text-align:center><code>eth7</code></td></tr><tr><td style=text-align:center>2.4GHz WLAN 访客网络1</td><td style=text-align:center><code>wl0.1</code></td></tr><tr><td style=text-align:center>2.4GHz WLAN 访客网络2</td><td style=text-align:center><code>wl0.2</code></td></tr><tr><td style=text-align:center>2.4GHz WLAN 访客网络3</td><td style=text-align:center><code>wl0.3</code></td></tr><tr><td style=text-align:center>5GHz WLAN 访客网络1</td><td style=text-align:center><code>wl1.1</code></td></tr><tr><td style=text-align:center>5GHz WLAN 访客网络2</td><td style=text-align:center><code>wl1.2</code></td></tr><tr><td style=text-align:center>5GHz WLAN 访客网络3</td><td style=text-align:center><code>wl1.3</code></td></tr></tbody></table><p>访客网络在下图中有两行三列，从左到右分别以 1、2、3 来表示。例如 2.4GHz 的第一列对应的系统内接口名称是 <code>wl0.1</code>，5GHz 的第二列对应的系统内接口名称是 <code>wl1.2</code>。</p><figure class=center><img src=Snipaste_2022-08-08_18-25-11.png></figure><h2 id=设置-wifi-的-vlan>设置 WiFi 的 VLAN
<a href=#%e8%ae%be%e7%bd%ae-wifi-%e7%9a%84-vlan class=h-anchor aria-hidden=true>#</a></h2><p>清楚了对应关系后，咱们就可以通过 SSH 进入 AX86U 的命令行里设置 VLAN 了。首先请确保 AX86U 的 SSH 功能是开启的，在 <code>系统管理</code> → <code>系统设置</code> → <code>服务</code> → <code>启用 SSH</code> 里可以设置。</p><p>下面的方法小玲参考了 Github Gist 上的<a href=https://gist.github.com/Jimmy-Z/6120988090b9696c420385e7e42c64c4>一段代码</a>，在此感谢这段代码的作者。</p><p>首先增加带 VLAN ID 的接口。这里使用 <code>eth0</code> 是因为小玲把连接着 R4S 的网线接到了 AX86U 的 WAN 口上了，而 WAN 口对应的系统内接口名称是 <code>eth0</code>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ip link add link eth0 name eth0.10 type vlan id <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>ip link add link eth0 name eth0.20 type vlan id <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>ip link add link eth0 name eth0.30 type vlan id <span style=color:#ae81ff>30</span>
</span></span></code></pre></div><p>通过 <code>ip link</code> 可以看到咱们刚添加的接口。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>29: eth0.10@eth0: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default
</span></span><span style=display:flex><span>    link/ether ██:██:██:██:██:██ brd ff:ff:ff:ff:ff:ff
</span></span><span style=display:flex><span>30: eth0.20@eth0: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default
</span></span><span style=display:flex><span>    link/ether ██:██:██:██:██:██ brd ff:ff:ff:ff:ff:ff
</span></span><span style=display:flex><span>31: eth0.30@eth0: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default
</span></span><span style=display:flex><span>    link/ether ██:██:██:██:██:██ brd ff:ff:ff:ff:ff:ff
</span></span></code></pre></div><p>可以看到咱们刚添加的接口都是 <code>DOWN</code> 的。因为光添加还不行，咱们还需要启用这些接口，把它变成 <code>UP</code> 的。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ip link set eth0.10 up
</span></span><span style=display:flex><span>ip link set eth0.20 up
</span></span><span style=display:flex><span>ip link set eth0.30 up
</span></span></code></pre></div><p>通过 <code>ip link</code> 可以看到咱们刚添加的接口已经启用了。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>29: eth0.10@eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default
</span></span><span style=display:flex><span>    link/ether ██:██:██:██:██:██ brd ff:ff:ff:ff:ff:ff
</span></span><span style=display:flex><span>30: eth0.20@eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default
</span></span><span style=display:flex><span>    link/ether ██:██:██:██:██:██ brd ff:ff:ff:ff:ff:ff
</span></span><span style=display:flex><span>31: eth0.30@eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default
</span></span><span style=display:flex><span>    link/ether ██:██:██:██:██:██ brd ff:ff:ff:ff:ff:ff
</span></span></code></pre></div><p>通过 <code>brctl show</code> 查看所有的网桥。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>admin@RT-AX86U-████:/tmp/home/root# brctl show
</span></span><span style=display:flex><span>bridge name     bridge id               STP enabled     interfaces
</span></span><span style=display:flex><span>br0             8000.████████████       no              eth0
</span></span><span style=display:flex><span>                                                        eth1
</span></span><span style=display:flex><span>                                                        eth2
</span></span><span style=display:flex><span>                                                        eth3
</span></span><span style=display:flex><span>                                                        eth4
</span></span><span style=display:flex><span>                                                        eth5
</span></span><span style=display:flex><span>                                                        eth6
</span></span><span style=display:flex><span>                                                        eth7
</span></span><span style=display:flex><span>                                                        wl0.1
</span></span><span style=display:flex><span>                                                        wl0.2
</span></span><span style=display:flex><span>                                                        wl0.3
</span></span><span style=display:flex><span>                                                        wl1.1
</span></span><span style=display:flex><span>                                                        wl1.2
</span></span></code></pre></div><p>可以看到默认只有一个网桥 <code>br0</code>，还需要添加三个网桥。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>brctl addbr br1
</span></span><span style=display:flex><span>brctl addbr br2
</span></span><span style=display:flex><span>brctl addbr br3
</span></span></code></pre></div><p>添加网桥后也要像上面启用接口一样启用网桥。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ip link set br1 up
</span></span><span style=display:flex><span>ip link set br2 up
</span></span><span style=display:flex><span>ip link set br3 up
</span></span></code></pre></div><p>再用 <code>brctl show</code> 查看，就可以看到已经添加了三个网桥。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>admin@RT-AX86U-████:/tmp/home/root# brctl show
</span></span><span style=display:flex><span>bridge name     bridge id               STP enabled     interfaces
</span></span><span style=display:flex><span>br0             8000.████████████       no              eth0
</span></span><span style=display:flex><span>                                                        eth1
</span></span><span style=display:flex><span>                                                        eth2
</span></span><span style=display:flex><span>                                                        eth3
</span></span><span style=display:flex><span>                                                        eth4
</span></span><span style=display:flex><span>                                                        eth5
</span></span><span style=display:flex><span>                                                        eth6
</span></span><span style=display:flex><span>                                                        eth7
</span></span><span style=display:flex><span>                                                        wl0.1
</span></span><span style=display:flex><span>                                                        wl0.2
</span></span><span style=display:flex><span>                                                        wl0.3
</span></span><span style=display:flex><span>                                                        wl1.1
</span></span><span style=display:flex><span>                                                        wl1.2
</span></span><span style=display:flex><span>br1             8000.000000000000       no
</span></span><span style=display:flex><span>br2             8000.000000000000       no
</span></span><span style=display:flex><span>br3             8000.000000000000       no
</span></span></code></pre></div><p>现在需要从 <code>br0</code> 网桥中删除不属于它的接口，需要用 <code>brctl delif</code> 这个命令，它的语法如下。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>brctl delif &lt;bridge&gt; &lt;device...&gt;
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>brctl delif br0 wl0.1 wl1.1 wl0.2 wl0.3 wl1.2
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>admin@RT-AX86U-████:/tmp/home/root# brctl show
</span></span><span style=display:flex><span>bridge name     bridge id               STP enabled     interfaces
</span></span><span style=display:flex><span>br0             8000.████████████       no              eth0
</span></span><span style=display:flex><span>                                                        eth1
</span></span><span style=display:flex><span>                                                        eth2
</span></span><span style=display:flex><span>                                                        eth3
</span></span><span style=display:flex><span>                                                        eth4
</span></span><span style=display:flex><span>                                                        eth5
</span></span><span style=display:flex><span>                                                        eth6
</span></span><span style=display:flex><span>                                                        eth7
</span></span><span style=display:flex><span>br1             8000.000000000000       no
</span></span><span style=display:flex><span>br2             8000.000000000000       no
</span></span><span style=display:flex><span>br3             8000.000000000000       no
</span></span></code></pre></div><p>小玲把 <code>2.4GHz WLAN 访客网络1</code> 和 <code>5GHz WLAN 访客网络1</code> 当作家人专用的 WiFi；<code>2.4GHz WLAN 访客网络2</code> 和 <code>5GHz WLAN 访客网络2</code> 当作访客专用的 WiFi，<code>2.4GHz WLAN 访客网络3</code> 当作智能家居专用的 WiFi。所以小玲需要把 <code>eth0.10</code>、<code>wl0.1</code>、<code>wl1.1</code> 这三个接口添加进 <code>br1</code> 网桥；<code>eth0.20</code>、<code>wl0.2</code>、<code>wl1.2</code> 添加进 <code>br2</code> 网桥；<code>eth0.30</code>、<code>wl0.3</code> 添加进 <code>br3</code> 网桥。</p><p>把接口添加进网桥需要用 <code>brctl addif</code> 这个命令，它的语法如下。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>brctl addif &lt;bridge&gt; &lt;device...&gt;
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>brctl addif br1 eth0.10 wl0.1 wl1.1
</span></span><span style=display:flex><span>brctl addif br2 eth0.20 wl0.2 wl1.2
</span></span><span style=display:flex><span>brctl addif br3 eth0.30 wl0.3
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>admin@RT-AX86U-████:/tmp/home/root# brctl show
</span></span><span style=display:flex><span>bridge name     bridge id               STP enabled     interfaces
</span></span><span style=display:flex><span>br0             8000.████████████       no              eth0
</span></span><span style=display:flex><span>                                                        eth1
</span></span><span style=display:flex><span>                                                        eth2
</span></span><span style=display:flex><span>                                                        eth3
</span></span><span style=display:flex><span>                                                        eth4
</span></span><span style=display:flex><span>                                                        eth5
</span></span><span style=display:flex><span>                                                        eth6
</span></span><span style=display:flex><span>                                                        eth7
</span></span><span style=display:flex><span>br1             8000.████████████       no              eth0.10
</span></span><span style=display:flex><span>                                                        wl0.1
</span></span><span style=display:flex><span>                                                        wl1.1
</span></span><span style=display:flex><span>br2             8000.████████████       no              eth0.20
</span></span><span style=display:flex><span>                                                        wl0.2
</span></span><span style=display:flex><span>                                                        wl1.2
</span></span><span style=display:flex><span>br3             8000.████████████       no              eth0.30
</span></span><span style=display:flex><span>                                                        wl0.3
</span></span></code></pre></div><p>这时候已经成功了，小玲试着连接上家人专用的 WiFi，可以看到被分配的 IPv4 地址正好在 <code>192.168.3.64/26</code> 内，连接上访客专用的 WiFi，IPv4 地址正好在 <code>192.168.3.128/26</code> 之内，连接上智能家居专用的 WiFi，IPv4 地址正好在 <code>192.168.3.192/26</code> 之内。</p><h2 id=自动化>自动化
<a href=#%e8%87%aa%e5%8a%a8%e5%8c%96 class=h-anchor aria-hidden=true>#</a></h2><p>现在已经实现了想要的功能，接下来就要让 AX86U 自动帮咱们完成上面这一整套步骤。小玲为此写了一个脚本。要想保存这个脚本，请先打开 AX86U 设置中的 <code>系统管理</code> → <code>系统设置</code> → <code>Persistent JFFS2 partition</code> → <code>Enable JFFS custom scripts and configs</code>。</p><p>AX86U 的系统里没有 vim，所以咱们只能用 vi。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vi /jffs/scripts/vlan
</span></span></code></pre></div><p>写入以下内容</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e># 这个变量的值是连接软路由的那个网口的系统内的接口名称，小玲用的是 WAN 口，所以是 eth0。</span>
</span></span><span style=display:flex><span>lan_ifname<span style=color:#f92672>=</span>eth0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 这个函数的作用是增加并启用带有 VLAN ID 的接口，如果要添加的接口已存在就什么也不做。</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 形参1：接口名称</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 形参2：VLAN ID</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 例如 &#34;add_vlan_if eth0 10&#34; 会在 &#34;eth0.10&#34; 这个 VLAN ID 为 10 的接口不存在时添加这个接口。 </span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> add_vlan_if<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    ip link | grep $1.$2 &gt; /dev/null
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> $? <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        ip link add link $1 name <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>1<span style=color:#e6db74>}</span><span style=color:#e6db74>.</span><span style=color:#e6db74>${</span>2<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> type vlan id $2
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    ip link show $1.$2 | grep DOWN &gt; /dev/null
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> $? <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        ip link set <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>1<span style=color:#e6db74>}</span><span style=color:#e6db74>.</span><span style=color:#e6db74>${</span>2<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> up
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 这个函数的作用是增加并启用网桥，如果要添加的网桥已存在就什么也不做。</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 形参1：网桥名称</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 例如 &#34;add_br br1&#34; 会在 &#34;br1&#34; 这个网桥不存在时添加这个网桥。 </span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> add_br<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    brctl show | grep $1 &gt; /dev/null
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> $? <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        brctl addbr $1 &gt; /dev/null
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    ip link show $1 | grep DOWN &gt; /dev/null
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> $? <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        ip link set $1 up &gt; /dev/null
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 这个函数的作用是把一个接口添加到网桥，如果要添加的接口已经在这个网桥里了就什么也不做。</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 形参1：网桥名称</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 形参2：接口名称</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 例如 &#34;add_if_to_br br1 eth0.10&#34; 会在 &#34;eth0.10&#34; 这个接口不在 &#34;br1&#34; 网桥里时，将 &#34;eth0.10&#34; 接口添加进 &#34;br1&#34; 网桥。 </span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> add_if_to_br<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    brctl show $1 | grep $2 &gt; /dev/null
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> $? <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        brctl addif $1 $2 &gt; /dev/null
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 这个函数的作用是把一个接口从一个网桥里删除，如果要删除的接口不在这个网桥里就什么也不做。</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 形参1：网桥名称</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 形参2：接口名称</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 例如 &#34;delete_if_from_br br1 eth0.10&#34; 会在 &#34;eth0.10&#34; 这个接口在 &#34;br1&#34; 网桥里时，将 &#34;eth0.10&#34; 接口从 &#34;br1&#34; 网桥里删除。 </span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> delete_if_from_br<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    brctl show $1 | grep $2 &gt; /dev/null
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> $? <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        brctl delif br0 $2 &gt; /dev/null
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 下面的语句都是调用上面的函数了。</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 添加并启用 &#34;eth0.10&#34;、&#34;eth0.20&#34; &#34;eth0.30&#34; 三个接口。</span>
</span></span><span style=display:flex><span>add_vlan_if $lan_ifname <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>add_vlan_if $lan_ifname <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>add_vlan_if $lan_ifname <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 添加并启用 &#34;br1&#34;、&#34;br2&#34;、&#34;br3&#34; 三个网桥。</span>
</span></span><span style=display:flex><span>add_br br1
</span></span><span style=display:flex><span>add_br br2
</span></span><span style=display:flex><span>add_br br3
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 把用到的访客网络的接口从 `br0` 网桥里删除。</span>
</span></span><span style=display:flex><span>delete_if_from_br br0 wl0.1
</span></span><span style=display:flex><span>delete_if_from_br br0 wl0.2
</span></span><span style=display:flex><span>delete_if_from_br br0 wl0.3
</span></span><span style=display:flex><span>delete_if_from_br br0 wl1.1
</span></span><span style=display:flex><span>delete_if_from_br br0 wl1.2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 添加接口到相应的网桥里。</span>
</span></span><span style=display:flex><span>add_if_to_br br1 $lan_ifname.10
</span></span><span style=display:flex><span>add_if_to_br br1 wl0.1
</span></span><span style=display:flex><span>add_if_to_br br1 wl1.1
</span></span><span style=display:flex><span>add_if_to_br br2 $lan_ifname.20
</span></span><span style=display:flex><span>add_if_to_br br2 wl0.2
</span></span><span style=display:flex><span>add_if_to_br br2 wl1.2
</span></span><span style=display:flex><span>add_if_to_br br3 $lan_ifname.30
</span></span><span style=display:flex><span>add_if_to_br br3 wl0.3
</span></span></code></pre></div><p>可惜 AX86U 的 Shell 是那种超简陋的 Shell，连数组都不能定义，不然小玲可以写数组遍历的。</p><p>给脚本添加执行权限。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>chmod +x /jffs/scripts/vlan
</span></span></code></pre></div><p>为了让 AX86U 每次开机时都执行一遍这个脚本，咱们需要在 <code>/jffs/scripts/services-start</code> 这个文件里添加这么一行。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/jffs/scripts/vlan
</span></span></code></pre></div><p>这样 AX86U 每次开机时就会自动配置好 VLAN、网桥什么的。不过有时候咱们更改了 AX86U 的一些设置都会导致网桥和接口复原，这时候只能进 SSH 手动执行一下脚本来恢复配置，或者用一个笨办法，那就是用定时任务每分钟执行一遍脚本来自动恢复设置。这个问题小玲暂时找不到很好的解决方法，如果你知道解决方法，不妨在评论区告诉小玲。</p><h2 id=防火墙配置>防火墙配置
<a href=#%e9%98%b2%e7%81%ab%e5%a2%99%e9%85%8d%e7%bd%ae class=h-anchor aria-hidden=true>#</a></h2><p>现在小玲连接上访客专用的 WiFi（<code>192.168.3.128/26</code> 网段），并试图去 ping 处于 <code>192.168.3.0/26</code> 的 NAS 时，发现是可以 ping 通的，这样是不行的。小玲的想法是小玲专用的局域网里的设备能主动访问其它三个局域网里的设备，其他三个局域网的设备只能主动访问它自己网内的设备。用表格表示如下。</p><table><thead><tr><th style=text-align:center>访问方\被访问方</th><th style=text-align:center>小玲专用的局域网</th><th style=text-align:center>家人专用的局域网</th><th style=text-align:center>访客专用的局域网</th><th style=text-align:center>智能家居专用的局域网</th></tr></thead><tbody><tr><td style=text-align:center>小玲专用的局域网</td><td style=text-align:center>✓</td><td style=text-align:center>✓</td><td style=text-align:center>✓</td><td style=text-align:center>✓</td></tr><tr><td style=text-align:center>家人专用的局域网</td><td style=text-align:center>✗</td><td style=text-align:center>✓</td><td style=text-align:center>✗</td><td style=text-align:center>✗</td></tr><tr><td style=text-align:center>访客专用的局域网</td><td style=text-align:center>✗</td><td style=text-align:center>✗</td><td style=text-align:center>✓</td><td style=text-align:center>✗</td></tr><tr><td style=text-align:center>智能家居专用的局域网</td><td style=text-align:center>✗</td><td style=text-align:center>✗</td><td style=text-align:center>✗</td><td style=text-align:center>✓</td></tr></tbody></table><p>这个需求可以在 R4S 上通过 nftables 实现。在 <code>filter</code> 表里的 <code>forward</code> 链里添加这么一句就能禁止其它三个局域网里的设备主动访问小玲专用的局域网里的设备。同时小玲专用的局域网里的设备能正常访问其他三个局域网里的设备。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo vim /etc/nftables.conf
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span># 已省略无关内容
</span></span><span style=display:flex><span>table inet filter {
</span></span><span style=display:flex><span>    chain forward {
</span></span><span style=display:flex><span>        type filter hook forward priority 0;
</span></span><span style=display:flex><span>        iifname enp1s0.10 oifname { enp1s0, enp1s0.20, enp1s0.30 } ct state { new, invalid } drop
</span></span><span style=display:flex><span>        iifname enp1s0.20 oifname { enp1s0, enp1s0.10, enp1s0.30 } ct state { new, invalid } drop
</span></span><span style=display:flex><span>        iifname enp1s0.30 oifname { enp1s0, enp1s0.10, enp1s0.20 } ct state { new, invalid } drop
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=ipv6-访问问题>IPv6 访问问题
<a href=#ipv6-%e8%ae%bf%e9%97%ae%e9%97%ae%e9%a2%98 class=h-anchor aria-hidden=true>#</a></h2><p>小玲用的宽带只能获取到一个 <code>/64</code> 的前缀，这个前缀已经用于小玲专用的局域网，让它里面的设备都有公网 IPv6 地址了。</p><p>由于没有更多的前缀，所以其它三个局域网里的设备无法获得公网 IPv6 地址。虽然如此，小玲还是至少要让其它三个局域网里的设备能正常访问 IPv6 地址，这时候就需要在 R4S 里用 nftables 做 IPv6 的 NAT。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo vim /etc/nftables.conf
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span># 已省略无关内容
</span></span><span style=display:flex><span>table ip6 ipv6-nat {
</span></span><span style=display:flex><span>    chain postrouting {
</span></span><span style=display:flex><span>        type nat hook postrouting priority srcnat; policy accept;
</span></span><span style=display:flex><span>        iifname { enp1s0.10, enp1s0.20, enp1s0.30 } oifname ppp0 masquerade
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>ppp0</code> 是小玲的 R4S PPPoE 拨号用的接口名称，请根据实际情况换成你的接口名称。</p><h2 id=结尾>结尾
<a href=#%e7%bb%93%e5%b0%be class=h-anchor aria-hidden=true>#</a></h2><p>好了，现在终于实现小玲的需求了。其实这个需求不用 AX86U 也能实现，一般能刷梅林的路由器应该都能像这篇文章一样操作。小玲并不是什么精通计算机的大佬，可能讲的不是很专业和严谨，如果有错误欢迎在评论区指出，在此感谢。</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>参考：<a href=https://www.v2ex.com/t/488116>为你的 IPv6 局域网配置 ULA 吧</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>参考：<a href=https://www.v2ex.com/t/510276>现在运营商分配 IPV6 地址前缀是/64 吗？</a>。&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>来源：<a href=https://www.snbforums.com/threads/vlans-trunk-interface-tagged-and-untagged-traffic-rt-ax86u-and-rt-ax88u.78411/>VLANs, Trunk interface, tagged and untagged traffic RT-AX86U and RT-AX88U</a>。&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>阅读其它文章</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://blog.bling.moe/post/8/><span class=button__icon>←</span>
<span class=button__text>分享一个 TranslucentTB 的配置</span></a></span>
<span class="button next"><a href=https://blog.bling.moe/post/6/><span class=button__text>华硕AX86U 鬼灭之刃版伪开箱</span>
<span class=button__icon>→</span></a></span></div></div><script src=https://giscus.app/client.js data-repo=HoshinoRei/blog data-repo-id=R_kgDOGZbNzw data-category=General data-category-id=DIC_kwDOGZbNz84CPgAu data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=1 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>星野玲的博客</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2025 Powered by <a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span><a href=https://github.com/panr/hugo-theme-hello-friend target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-E6TTBX28QL"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-E6TTBX28QL",{anonymize_ip:!1})}</script></body></html>