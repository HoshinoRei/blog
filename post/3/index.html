<!doctype html><html lang=zh-cn><head><title>使用 Debian 作为路由器 ::
星野玲的博客</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="在这篇文章里，小玲将教你如何将一个装着干净的 Debian 系统的设备变成一个能让局域网内设备上网的软路由。小玲使用一台 Nanopi R4S 作为演示用的设备，刷入的系统为"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://blog.bling.moe/post/3/><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://blog.bling.moe/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://blog.bling.moe/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://blog.bling.moe/img/favicon.png><link href=/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="使用 Debian 作为路由器"><meta name=twitter:description content="在这篇文章里，小玲将教你如何将一个装着干净的 Debian 系统的设备变成一个能让局域网内设备上网的软路由。"><meta property="og:title" content="使用 Debian 作为路由器"><meta property="og:description" content="在这篇文章里，小玲将教你如何将一个装着干净的 Debian 系统的设备变成一个能让局域网内设备上网的软路由。"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.bling.moe/post/3/"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-02-19T22:35:00+08:00"><meta property="article:modified_time" content="2021-11-18T14:08:07+08:00"><meta property="og:site_name" content="星野玲的博客"></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>星野玲的博客</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/index.xml>RSS</a></li><li><a href=/about/>关于</a></li><li><a href=/links/>友链</a></li><ul class=menu__sub-inner><li class=menu__sub-inner-more-trigger>查看更多
<span class=menu__sub-inner-more-trigger-icon><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span></li><ul class="menu__sub-inner-more hidden"><li><a href=https://digital-garden.bling.moe>数字花园</a></li></ul></ul></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/index.xml>RSS</a></li><li><a href=/about/>关于</a></li><li><a href=/links/>友链</a></li><li><a href=https://digital-garden.bling.moe>数字花园</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><article class=post><h1 class=post-title>使用 Debian 作为路由器</h1><div class=post-meta><time class=post-date>2022-02-19</time>
<span class=post-author>— 作者： 星野玲</span></div><span class=post-tags><a href=https://blog.bling.moe/tags/armbian/>#Armbian</a>&nbsp;
<a href=https://blog.bling.moe/tags/debian/>#Debian</a>&nbsp;
<a href=https://blog.bling.moe/tags/nanopi-r4s/>#Nanopi R4S</a>&nbsp;
<a href=https://blog.bling.moe/tags/%E8%B7%AF%E7%94%B1%E5%99%A8/>#路由器</a>&nbsp;
<a href=https://blog.bling.moe/tags/%E8%BD%AF%E8%B7%AF%E7%94%B1/>#软路由</a>&nbsp;</span><div class=post-content><p>在这篇文章里，小玲将教你如何将一个装着干净的 Debian 系统的设备变成一个能让局域网内设备上网的软路由。小玲使用一台 Nanopi R4S 作为演示用的设备，刷入的系统为 Armbian 21.08.1，Debian 版本为 11。你也可以用 X86 的设备，设置过程基本上没有区别。</p><p>将 Armbian 系统刷入 TF 卡后，咱们将卡插入 R4S 的 TF 卡槽里，使用一条网线接在原本的路由器的 LAN 口上，然后给 R4S 通电。</p><p>找到 R4S 通过 DHCP 获取的 IP 地址。用默认用户名 <code>root</code>，默认密码 <code>1234</code> 登录 SSH。在完成 Armbian 系统的初始设置后，咱们现在得到了一个干净的 Armbian 系统。下面的步骤都是用在 Armbian 系统的初始设置里创建的非 root 用户操作的。小玲不建议大家直接用 root 用户操作。</p><h2 id=设置密钥>设置密钥
<a href=#%e8%ae%be%e7%bd%ae%e5%af%86%e9%92%a5 class=h-anchor aria-hidden=true>#</a></h2><p>安装完后第一步是要确保路由器安全，因为当设置好后路由器是要暴露在公网上的。有人会扫描 IPv4 的 IP 段，然后再扫描能连通的 IP 地址的端口。如果发现是 SSH 端口，还会爆破。所以咱们要使用密钥文件登录，而且要把密码登录关闭。</p><p>创建存放密钥的文件夹，默认路径是家目录下的 <code>.ssh</code> 文件夹。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir ~/.ssh
</span></span></code></pre></div><p>写入密钥。这里密钥请替换成你自己的。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#e6db74>&#39;ssh-rsa &lt;private_key&gt;&#39;</span> &gt;&gt; ~/.ssh/authorized_keys
</span></span></code></pre></div><p>编辑 sshd 配置文件。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo vim /etc/ssh/sshd_config
</span></span></code></pre></div><p>将 <code>PermitRootLogin</code> 设为 <code>no</code> 以关闭 root 账号登录；将 <code>PubkeyAuthentication</code> 设为 <code>yes</code> 以开启密钥登录；<code>AuthorizedKeyFile</code> 为密钥路径；将 <code>PasswordAuthentication</code> 设为 <code>no</code> 以关闭密码登录。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>PermitRootLogin no
</span></span><span style=display:flex><span>PubkeyAuthentication yes
</span></span><span style=display:flex><span>AuthorizedKeyFile .ssh/authorized_keys .ssh/authorized_keys2
</span></span><span style=display:flex><span>PasswordAuthentication no
</span></span></code></pre></div><p>保存后，重启 SSH 服务。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl restart ssh
</span></span></code></pre></div><p>现在咱们可以在不关闭当前 SSH 连接的情况下新建一个用密钥登录的 SSH 连接。如果登录成功了，就可以断开用密码登录的 SSH 连接了。如果不出意外，现在就不能用密码登录了。</p><h2 id=更新系统>更新系统
<a href=#%e6%9b%b4%e6%96%b0%e7%b3%bb%e7%bb%9f class=h-anchor aria-hidden=true>#</a></h2><p>如果是 Armbian 系统，请先阻止 Armbian 系统的更新。经过小玲实测，截止至 2022 年 12 月 27 日，Nanopi R4S 的 Armbian 系统最稳定的版本是 21.08.1。一些更新的版本都会有一些 bug，例如 LAN 口在系统里消失，WAN 口的接口名称在 <code>eth1</code> 和 <code>eth0</code> 之间反复横跳。</p><p>在 Armbian 系统下，编辑 <code>/etc/apt/sources.list.d/armbian.list</code> 文件。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo vim /etc/apt/sources.list.d/armbian.list
</span></span></code></pre></div><p>在这一行前面加个 <code>#</code>，注释这一行。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>#deb http://apt.armbian.com bullseye main bullseye-utils bullseye-desktop
</span></span></code></pre></div><p>再把 Debian 更新到最新，如果不是 Armbian 系统，直接做这一步就可以了。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt update
</span></span><span style=display:flex><span>sudo apt upgrade -y
</span></span></code></pre></div><h2 id=设置网络>设置网络
<a href=#%e8%ae%be%e7%bd%ae%e7%bd%91%e7%bb%9c class=h-anchor aria-hidden=true>#</a></h2><p>查看一下网络配置文件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat /etc/network/interfaces
</span></span></code></pre></div><p>如果是 Armbian 系统，默认内容如下。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>source /etc/network/interfaces.d/*
</span></span><span style=display:flex><span># Network is managed by Network manager
</span></span><span style=display:flex><span>auto lo
</span></span><span style=display:flex><span>iface lo inet loopback
</span></span></code></pre></div><p>可以看到现在网络的配置是由 NetworkManager 接管的，原本的 Debian 系统是不预装 NetworkManager 的，为了和原本的 Debian 系统设置方法统一，Armbian 系统要把 NetworkManager 卸载掉。这个步骤只是 Armbian 系统才有的，Debian 系统不需要做此步骤。</p><p>在卸载 NetworkManager 前，需要先把 <code>/etc/network/interfaces</code> 文件的配置写上。咱们先查看一下接口名称。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ip a
</span></span></code></pre></div><p>返回如下。小玲自己的 IP 地址和 MAC 地址已打码。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
</span></span><span style=display:flex><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style=display:flex><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>    inet6 ::1/128 scope host
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>2: enp1s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
</span></span><span style=display:flex><span>    link/ether ██:██:██:██:██:██ brd ff:ff:ff:ff:ff:ff
</span></span><span style=display:flex><span>    inet 192.168.███.███/24 brd 192.168.███.███ scope global dynamic noprefixroute enp1s0
</span></span><span style=display:flex><span>       valid_lft 2338sec preferred_lft 2338sec
</span></span><span style=display:flex><span>    inet6 240█:████:████:████:████:████:████:████/64 scope global dynamic noprefixroute
</span></span><span style=display:flex><span>       valid_lft 3455sec preferred_lft 3455sec
</span></span><span style=display:flex><span>    inet6 fe80::362f:579d:8c86:105b/64 scope link noprefixroute
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>3: eth1: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc mq state DOWN group default qlen 1000
</span></span><span style=display:flex><span>    link/ether ██:██:██:██:██:██ brd ff:ff:ff:ff:ff:ff
</span></span></code></pre></div><p>现在咱们可以看到 LAN 口的接口名称是 <code>enp1s0</code>，WAN 口的接口名称是 <code>eth1</code>，LAN 口的 IPv6 本地链路地址是 <code>fe80::362f:579d:8c86:105b</code>，这个地址请记下来，待会可以用到。</p><p>编辑 <code>/etc/network/interfaces</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo vim /etc/network/interfaces
</span></span></code></pre></div><p>将文件改写成现在这个样子。小玲将 IPv4 网段设成了 <code>192.168.3.0/24</code>。当然网段你也可以改成你喜欢的。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>source /etc/network/interfaces.d/*
</span></span><span style=display:flex><span>auto lo
</span></span><span style=display:flex><span>iface lo inet loopback
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>auto enp1s0
</span></span><span style=display:flex><span>allow-hotplug enp1s0
</span></span><span style=display:flex><span>iface enp1s0 inet static
</span></span><span style=display:flex><span>    address 192.168.3.1/24
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>auto eth1
</span></span><span style=display:flex><span>allow-hotplug eth1
</span></span><span style=display:flex><span>iface eth1 inet dhcp
</span></span><span style=display:flex><span>iface eth1 inet6 auto
</span></span></code></pre></div><p>保存好以后就可以卸载 NetworkManager 了。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt remove -y network-manager
</span></span><span style=display:flex><span>sudo apt autoremove -y
</span></span></code></pre></div><h2 id=开启转发>开启转发
<a href=#%e5%bc%80%e5%90%af%e8%bd%ac%e5%8f%91 class=h-anchor aria-hidden=true>#</a></h2><p>编辑 <code>/etc/sysctl.conf</code> 文件。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo vim /etc/sysctl.conf
</span></span></code></pre></div><p>在 <code>/etc/sysctl.conf</code> 的末尾添加以下内容。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>net.ipv4.ip_forward=1
</span></span><span style=display:flex><span>net.ipv6.conf.all.disable_ipv6 = 0
</span></span><span style=display:flex><span>net.ipv6.conf.default.disable_ipv6 = 0
</span></span><span style=display:flex><span>net.ipv6.conf.lo.disable_ipv6 = 0
</span></span><span style=display:flex><span>net.ipv6.conf.all.forwarding=1
</span></span><span style=display:flex><span>net.ipv6.conf.default.forwarding=1
</span></span><span style=display:flex><span>net.ipv6.conf.default.accept_ra=2
</span></span><span style=display:flex><span>net.ipv6.conf.default.use_tempaddr=1
</span></span></code></pre></div><p>应用配置。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo sysctl -p
</span></span></code></pre></div><p>因为之前咱们更新了系统。现在最好重启一下，顺便应用新的网络设置。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo reboot
</span></span></code></pre></div><p>重启之后 R4S 的 LAN 口的 IP 地址已经变成了 <code>192.168.3.0/24</code> 这个网段了，不能再通过将 R4S 的 LAN 口连接原来的路由器的 LAN 口来获取原来的路由器的 IP 地址了。所以咱们需要使用一条网线连接着 R4S 的 LAN 口和电脑，一条网线连接的原本路由器的 LAN 口和 R4S 的 WAN 口。因为 R4S 上现在还没有 DHCP 服务，所以咱们需要把电脑的 IPv4 地址设为与 R4S 的 LAN 口的 IPv4 地址同一网段的 IPv4 地址。这里咱们就设成 <code>192.168.3.2</code>，子网前缀长度是 <code>24</code>，网关是 R4S 的 IP 地址 <code>192.168.3.1</code>。IPv6 先不用管。</p><p>设置完电脑的 IP 地址后，通过 SSH 连接到 <code>192.168.3.1</code> 来继续设置 R4S。</p><h2 id=安装必要的软件>安装必要的软件
<a href=#%e5%ae%89%e8%a3%85%e5%bf%85%e8%a6%81%e7%9a%84%e8%bd%af%e4%bb%b6 class=h-anchor aria-hidden=true>#</a></h2><p>这些软件都是接下来要使用的。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt install -y nftables pppoeconf
</span></span></code></pre></div><p>使用 Docker 能减少软件的部署的难度。所以也安装上。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo wget -qO- https://get.docker.com/ | sh
</span></span></code></pre></div><p>安装 Docker Compose。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo wget <span style=color:#e6db74>&#34;https://github.com/docker/compose/releases/download/v2.14.2/docker-compose-</span><span style=color:#66d9ef>$(</span>uname -s<span style=color:#66d9ef>)</span><span style=color:#e6db74>-</span><span style=color:#66d9ef>$(</span>uname -m<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> -O /usr/local/bin/docker-compose
</span></span><span style=display:flex><span>sudo chmod +x /usr/local/bin/docker-compose
</span></span></code></pre></div><h2 id=配置-dnsmasq>配置 Dnsmasq
<a href=#%e9%85%8d%e7%bd%ae-dnsmasq class=h-anchor aria-hidden=true>#</a></h2><p>创建一个文件夹来存放 Dnsmasq 的配置文件。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p ~/config/dnsmasq
</span></span></code></pre></div><p>编写 <code>dnsmasq.conf</code>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vim ~/config/dnsmasq/dnsmasq.conf
</span></span></code></pre></div><p>写入以下内容。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>interface=enp1s0
</span></span><span style=display:flex><span>port=53
</span></span><span style=display:flex><span>server=8.8.8.8
</span></span><span style=display:flex><span>server=8.8.4.4
</span></span><span style=display:flex><span>enable-ra
</span></span><span style=display:flex><span>log-dhcp
</span></span><span style=display:flex><span>dhcp-range=192.168.3.2,192.168.3.254,1h
</span></span><span style=display:flex><span>dhcp-range=::,constructor:enp1s0,ra-stateless,1h
</span></span><span style=display:flex><span>dhcp-option=option:router,192.168.3.1
</span></span><span style=display:flex><span>dhcp-option=option:dns-server,192.168.3.1
</span></span><span style=display:flex><span>dhcp-option=option6:dns-server,[fe80::362f:579d:8c86:105b]
</span></span></code></pre></div><p><code>interface</code> 是 LAN 口的接口名称。</p><p><code>port</code> 是 R4S 上的 DNS 服务的端口，一般都要设为 <code>53</code>。</p><p><code>server</code> 是上游 DNS 服务器的地址，这里就以谷歌的 DNS 服务器作为例子。</p><p><code>enable-ra</code> 是用于向局域网内分发 IPv6 地址的。</p><p><code>log-dhcp</code> 用于在日志中记录 DHCP 信息。</p><p><code>dhcp-range</code> 是 DHCP 分发 IP 地址的范围，后面的 <code>1h</code> 是过期所需要的时间。</p><p><code>dhcp-option=option:router</code> 是向局域网内宣告的 IPv4 网关地址。</p><p><code>dhcp-option=option:dns-server</code> 是向局域网内宣告的 IPv4 DNS 服务器地址。</p><p><code>dhcp-option=option6:dns-server</code> 是向局域网内宣告的 IPv6 DNS 服务器地址。</p><p>编辑 <code>docker-compose.yml</code> 文件，咱们使用 Dnsmasq 的 Docker 版来提供 DNS 和 DHCP 服务。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vim ~/docker-compose.yml
</span></span></code></pre></div><p>写入以下内容。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#34;3&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>dnsmasq</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>dnsmasq</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>cap_add</span>: 
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>NET_ADMIN</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>hoshinorei/dnsmasq</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>network_mode</span>: <span style=color:#ae81ff>host</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./config/dnsmasq/dnsmasq.conf:/etc/dnsmasq.conf:ro</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span></code></pre></div><p>这里的 Dnsmasq 容器必须要使用 <code>host</code> 网络模式，<code>bridge</code> 是不行的。</p><p>启动容器。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo docker-compose -f ~/docker-compose.yml up -d
</span></span></code></pre></div><p>现在把电脑的 IP 地址从静态改回 DHCP 的。咱们可以发现现在已经可以通过 DHCP 获取 IP 地址了。</p><h2 id=pppoe-拨号>PPPoE 拨号
<a href=#pppoe-%e6%8b%a8%e5%8f%b7 class=h-anchor aria-hidden=true>#</a></h2><p>现在咱们可以开始连接外网了，咱们把连接 R4S 的 WAN 口的那条网线连接到光猫上。然后执行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo pppoeconf
</span></span></code></pre></div><p>这时候开始扫描哪个接口能连接 PPPoE。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>┌───────────────────┤ SCANNING DEVICE ├────────────────────┐
</span></span><span style=display:flex><span>│ Looking for PPPoE Access Concentrator on enp1s0...       │
</span></span><span style=display:flex><span>│                            66%                           │
</span></span><span style=display:flex><span>└──────────────────────────────────────────────────────────┘
</span></span></code></pre></div><p>这里选择 <code>Yes</code>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>┌────────────────────────┤ POPULAR OPTIONS ├─────────────────────────┐
</span></span><span style=display:flex><span>│ Most people using popular dialup providers prefer the options      │
</span></span><span style=display:flex><span>│ &#39;noauth&#39; and &#39;defaultroute&#39; in their configuration and remove the  │
</span></span><span style=display:flex><span>│ &#39;nodetach&#39; option. Should I check your configuration file and      │
</span></span><span style=display:flex><span>│ change these settings where neccessary?                            │
</span></span><span style=display:flex><span>│                  &lt;Yes&gt;                     &lt;No&gt;                    │
</span></span><span style=display:flex><span>└────────────────────────────────────────────────────────────────────┘
</span></span></code></pre></div><p>这里输入宽带用户名。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>┌────────────────────┤ ENTER USERNAME ├────────────────────┐
</span></span><span style=display:flex><span>│ Please enter the username which you usually need for the │
</span></span><span style=display:flex><span>│ PPP login to your provider in the input box below. If    │
</span></span><span style=display:flex><span>│ you wish to see the help screen, delete the username and │
</span></span><span style=display:flex><span>│ press OK.                                                │
</span></span><span style=display:flex><span>│                                                          │
</span></span><span style=display:flex><span>│ ________________________________________________________ │
</span></span><span style=display:flex><span>│                          &lt;Ok&gt;                            │
</span></span><span style=display:flex><span>└──────────────────────────────────────────────────────────┘
</span></span></code></pre></div><p>这里输入宽带密码。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>┌────────────────────┤ ENTER PASSWORD ├────────────────────┐
</span></span><span style=display:flex><span>│ Please enter the password which you usually need for the │
</span></span><span style=display:flex><span>│ PPP login to your provider in the input box below.       │
</span></span><span style=display:flex><span>│                                                          │
</span></span><span style=display:flex><span>│ NOTE: you can see the password in plain text while       │
</span></span><span style=display:flex><span>│ typing.                                                  │
</span></span><span style=display:flex><span>│                                                          │
</span></span><span style=display:flex><span>│ ________________________________________________________ │
</span></span><span style=display:flex><span>│                          &lt;Ok&gt;                            │
</span></span><span style=display:flex><span>└──────────────────────────────────────────────────────────┘
</span></span></code></pre></div><p>这里选 <code>No</code>，因为咱们已经有 Dnsmasq 了，咱们可以将路由器自身的 DNS 请求交给 Dnsmasq 处理。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>┌─────────────────────┤ USE PEER DNS ├─────────────────────┐
</span></span><span style=display:flex><span>│ You need at least one DNS IP address to resolve the      │
</span></span><span style=display:flex><span>│ normal host names. Normally your provider sends you      │
</span></span><span style=display:flex><span>│ addresses of useable servers when the connection is      │
</span></span><span style=display:flex><span>│ established. Would you like to add these addresses       │
</span></span><span style=display:flex><span>│ automatically to the list of nameservers in your local   │
</span></span><span style=display:flex><span>│ /etc/resolv.conf file? (recommended)                     │
</span></span><span style=display:flex><span>│               &lt;Yes&gt;                  &lt;No&gt;                │
</span></span><span style=display:flex><span>└──────────────────────────────────────────────────────────┘
</span></span></code></pre></div><p>这里选 <code>Yes</code>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>┌──────────────────────┤ LIMITED MSS PROBLEM ├───────────────────────┐
</span></span><span style=display:flex><span>│                                                                    │
</span></span><span style=display:flex><span>│ Many providers have routers that do not support TCP packets with a │
</span></span><span style=display:flex><span>│ MSS higher than 1460. Usually, outgoing packets have this MSS when │
</span></span><span style=display:flex><span>│ they go through one real Ethernet link with the default MTU size   │
</span></span><span style=display:flex><span>│ (1500). Unfortunately, if you are forwarding packets from other    │
</span></span><span style=display:flex><span>│ hosts (i.e. doing masquerading) the MSS may be increased depending │
</span></span><span style=display:flex><span>│ on the packet size and the route to the client hosts, so your      │
</span></span><span style=display:flex><span>│ client machines won&#39;t be able to connect to some sites. There is a │
</span></span><span style=display:flex><span>│ solution: the maximum MSS can be limited by pppoe. You can find    │
</span></span><span style=display:flex><span>│ more details about this issue in the pppoe documentation.          │
</span></span><span style=display:flex><span>│                                                                    │
</span></span><span style=display:flex><span>│ Should pppoe clamp MSS at 1452 bytes?                              │
</span></span><span style=display:flex><span>│                                                                    │
</span></span><span style=display:flex><span>│ If unsure, say yes.                                                │
</span></span><span style=display:flex><span>│                                                                    │
</span></span><span style=display:flex><span>│ (If you still get problems described above, try setting to 1412 in │
</span></span><span style=display:flex><span>│ the dsl-provider file.)                                            │
</span></span><span style=display:flex><span>│                                                                    │
</span></span><span style=display:flex><span>│                  &lt;Yes&gt;                     &lt;No&gt;                    │
</span></span><span style=display:flex><span>│                                                                    │
</span></span><span style=display:flex><span>└────────────────────────────────────────────────────────────────────┘
</span></span></code></pre></div><p>这里问咱们是否要在开机时自动拨号，作为一个路由器当然要在开机时自动拨号啦。所以咱们选 <code>Yes</code>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>┌─────────────────────────┤ DONE ├─────────────────────────┐
</span></span><span style=display:flex><span>│ Your PPPD is configured now. Would you like to start the │
</span></span><span style=display:flex><span>│ connection at boot time?                                 │
</span></span><span style=display:flex><span>│               &lt;Yes&gt;                  &lt;No&gt;                │
</span></span><span style=display:flex><span>└──────────────────────────────────────────────────────────┘
</span></span></code></pre></div><p>这里告诉咱们可以使用 <code>pon dsl-provider</code> 开启连接；使用 <code>poff</code> 关闭连接。然后问咱们是否现在就开启连接？咱们选择 <code>Yes</code>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>┌────────────────┤ ESTABLISH A CONNECTION ├────────────────┐
</span></span><span style=display:flex><span>│ Now, you can make a DSL connection with &#34;pon             │
</span></span><span style=display:flex><span>│ dsl-provider&#34; and terminate it with &#34;poff&#34;. Would you    │
</span></span><span style=display:flex><span>│ like to start the connection now?                        │
</span></span><span style=display:flex><span>│               &lt;Yes&gt;                  &lt;No&gt;                │
</span></span><span style=display:flex><span>└──────────────────────────────────────────────────────────┘
</span></span></code></pre></div><p>选择 <code>Ok</code>，结束配置。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>┌─────────────────┤ CONNECTION INITIATED ├─────────────────┐
</span></span><span style=display:flex><span>│ The DSL connection has been triggered. You can use the   │
</span></span><span style=display:flex><span>│ &#34;plog&#34; command to see the status or &#34;ip addr show ppp0&#34;  │
</span></span><span style=display:flex><span>│ for general interface info.                              │
</span></span><span style=display:flex><span>│                          &lt;Ok&gt;                            │
</span></span><span style=display:flex><span>└──────────────────────────────────────────────────────────┘
</span></span></code></pre></div><p>现在可以查看一下所有接口的 IP 地址。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ip a
</span></span></code></pre></div><p>咱们可以看到多了一个名为 <code>ppp0</code> 的接口，并且成功获取了外网的 IP 地址。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>4: ppp0: &lt;POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP&gt; mtu 1492 qdisc pfifo_fast state UNKNOWN group default qlen 3
</span></span><span style=display:flex><span>    link/ppp
</span></span><span style=display:flex><span>    inet ███.███.███.███ peer ███.███.███.1/32 scope global ppp0
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>    inet6 240█:████:████:████:████:████:████:████/64 scope global temporary dynamic
</span></span><span style=display:flex><span>       valid_lft 259127sec preferred_lft 85894sec
</span></span><span style=display:flex><span>    inet6 240█:████:████:████:████:████:████:████/64 scope global dynamic mngtmpaddr
</span></span><span style=display:flex><span>       valid_lft 259127sec preferred_lft 172727sec
</span></span><span style=display:flex><span>    inet6 fe80::████:████:████:████ peer fe80::████:████:████:████/128 scope link
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></div><p>咱们在 R4S 上 ping 一下外网的 IP，已经可以 ping 通。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>nanopi-r4s:~:% ping 8.8.8.8
</span></span><span style=display:flex><span>PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
</span></span><span style=display:flex><span>64 bytes from 8.8.8.8: icmp_seq=1 ttl=116 time=19.9 ms
</span></span><span style=display:flex><span>64 bytes from 8.8.8.8: icmp_seq=2 ttl=116 time=19.8 ms
</span></span></code></pre></div><p>但是 ping 域名就不行了。查看一下 <code>/etc/resolv.conf</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat /etc/resolv.conf
</span></span></code></pre></div><p>原来这里的 DNS 还是使用以前的路由器宣告的 DNS。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span># Generated by NetworkManager
</span></span><span style=display:flex><span>nameserver 192.168.█.1
</span></span><span style=display:flex><span>nameserver fe80::████:████:████:████%enp1s0
</span></span></code></pre></div><p>编辑 <code>/etc/resolv.conf</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo vim /etc/resolv.conf
</span></span></code></pre></div><p>将文件内容改为</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>nameserver ::1
</span></span></code></pre></div><p>保存后，ping 域名也能 ping 通了，这是因为路由器自身的 DNS 请求已经交给自身的 Dnsmasq 处理了。所以为了路由器自身能正常上网，Dnsmasq 要一直运行着。</p><p>但是现在电脑还是不能 ping 通外网的 IPv4 地址 ，这是因为咱们没有做 IPv4 的 NAT 转换。</p><h2 id=开启-nat-转换>开启 NAT 转换
<a href=#%e5%bc%80%e5%90%af-nat-%e8%bd%ac%e6%8d%a2 class=h-anchor aria-hidden=true>#</a></h2><p>咱们使用 nftables 来开启 NAT 转换。</p><p>编辑 <code>/etc/nftables.conf</code> 文件。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo vim /etc/nftables.conf
</span></span></code></pre></div><p>里面已经写好了一些规则。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>#!/usr/sbin/nft -f
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>flush ruleset
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>table inet filter {
</span></span><span style=display:flex><span>    chain input {
</span></span><span style=display:flex><span>        type filter hook input priority 0;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    chain forward {
</span></span><span style=display:flex><span>        type filter hook forward priority 0;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    chain output {
</span></span><span style=display:flex><span>        type filter hook output priority 0;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>咱们把规则修改成这个样子。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>#!/usr/sbin/nft -f
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>table inet filter
</span></span><span style=display:flex><span>delete table inet filter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>table inet filter {
</span></span><span style=display:flex><span>    chain input {
</span></span><span style=display:flex><span>        type filter hook input priority 0;
</span></span><span style=display:flex><span>        iifname &#34;ppp0&#34; tcp dport { 80, 443 } drop
</span></span><span style=display:flex><span>        iifname &#34;ppp0&#34; udp dport { 53 } drop
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    chain forward {
</span></span><span style=display:flex><span>        type filter hook forward priority 0;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    chain output {
</span></span><span style=display:flex><span>        type filter hook output priority 0;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>table ip ipv4-nat
</span></span><span style=display:flex><span>delete table ip ipv4-nat
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>table ip ipv4-nat {
</span></span><span style=display:flex><span>    chain postrouting {
</span></span><span style=display:flex><span>        type nat hook postrouting priority srcnat; policy accept;
</span></span><span style=display:flex><span>        oifname { eth1, ppp0 } masquerade
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>咱们在 <code>filter</code> 表里的 <code>input</code> 链创建了一条规则 <code>iifname "ppp0" tcp dport { 80, 443 } drop</code>。这条规则的意思是从 <code>ppp0</code> 接口进来的访问 TCP 端口 80 和 443 的数据包全部禁止。设置这条规则的原因是在中国，家宽是不能私自做 WEB 服务的。咱们提前禁止这两个端口从外部的访问。之后就算在路由器上开了 WEB 服务。因为从外部访问不了，就不会有喝茶的风险了。</p><p><code>iifname "ppp0" udp dport { 53 } drop</code> 这条规则的意思是禁止从 <code>ppp0</code> 接口进来的对 UDP 端口 53 的访问。因为咱们的 Dnsmasq 只是用来对局域网提供 DNS 服务，没有必要对外网提供 DNS 服务，所以顺便禁止了。</p><p>这里咱们创建了一个表 <code>ipv4-nat</code>。表名前面的 <code>ip</code> 意思是这个表只对 IPv4 有效。然后在表里新建了链 <code>postrouting</code>。<code>type nat</code> 的意思是这条链的类型是 <code>nat</code>；<code>hook postrouting</code> 的意思是这条链会被挂到 <code>postrouting</code> 钩子上；<code>priority srcnat</code> 的意思是这条链的优先级是 <code>srcnat</code>；<code>policy accept</code> 的意思是这条链的默认规则是“接受”。小玲这么说你可能不太理解，如果你理解 iptables，那么现在的 <code>ipv4-nat</code> 表中的 <code>postrouting</code> 链的功能就和 iptables 中的 <code>nat</code> 表的 <code>POSTROUTING</code> 链的功能差不多。</p><p><code>oifname { eth1, ppp0 } masquerade</code> 的意思是从 <code>eth1</code> 和 <code>ppp0</code> 出去的数据包做 NAT 转换。</p><p><code>table inet filter</code> 和 <code>delete table inet filter</code> 这两句的作用是在使用 <code>sudo systemctl reload nftables</code> 命令重载 nftables 规则时先把已有的表删除再添加，防止规则重复添加。</p><p>启动 nftables 服务，这样咱们写的规则就会被加载了，顺便将 nftables 设为自启。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo systemctl enable nftables
</span></span><span style=display:flex><span>sudo systemctl start nftables
</span></span></code></pre></div><h2 id=给内网分配-ipv6-地址>给内网分配 IPv6 地址
<a href=#%e7%bb%99%e5%86%85%e7%bd%91%e5%88%86%e9%85%8d-ipv6-%e5%9c%b0%e5%9d%80 class=h-anchor aria-hidden=true>#</a></h2><p>这时候虽然路由器有公网 IPv6 地址了，可是局域网的设备并没有公网 IPv6 地址。现在咱们要使用 wide-dhcpv6-client 来获取 PD 前缀，这样局域网的设备就能被分配到公网 IPv6 地址了。</p><p>创建一个文件夹来存放 wide-dhcpv6-client 的配置文件。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p ~/config/wide-dhcpv6-client
</span></span></code></pre></div><p>编写 <code>dhcp6c.conf</code>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vim ~/config/wide-dhcpv6-client/dhcp6c.conf
</span></span></code></pre></div><p>写入以下内容。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>interface ppp0 {
</span></span><span style=display:flex><span>    send ia-pd 0;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>id-assoc pd 0 {
</span></span><span style=display:flex><span>    prefix-interface enp1s0 {
</span></span><span style=display:flex><span>        sla-len 0;
</span></span><span style=display:flex><span>        ifid 0;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p><code>interface ppp0</code> 这里的 <code>ppp0</code> 是连接外网的接口名称。</p><p><code>send ia-pd 0</code> 的意思是发送获取 PD 的请求，并把这个 PD 的 ID 设为 <code>0</code>。</p><p><code>id-assoc pd 0</code> 的意思是对 ID 为 <code>0</code> 的 PD 进行处理。</p><p><code>prefix-interface enp1s0</code> 的意思是将 PD 前缀绑定到 <code>enp1s0</code> 接口上。这里的接口名称请替换成你的 LAN 口的接口名称。</p><p><code>sla-len</code> 这个值要根据你能获取到的 PD 前缀长度来决定。公式是 <code>64 - 你能获取到的 PD 长度</code><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>。小玲只能获取到 <code>/64</code> 的前缀。所以小玲的 <code>sla-len</code> 的值为 <code>64-64=0</code>。</p><p><code>ifid</code> 这个值可以用来固定 LAN 口接口的主机号，把 <code>ifid</code> 设为 <code>0</code> 并且 <code>sla-len</code> 是 <code>0</code> 的话，那么 LAN 口的公网 IPv6 地址将会是 <code>240█:████:████:████::</code>。如果不希望这个地址固定，还可以用 <code>if-id-random</code> 来替换这行。</p><p>编辑 <code>docker-compose.yml</code> 文件，加入 wide-dhcpv6-client 的配置。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vim ~/docker-compose.yml
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#34;3&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>dnsmasq</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>dnsmasq</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>cap_add</span>: 
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>NET_ADMIN</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>hoshinorei/dnsmasq</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>network_mode</span>: <span style=color:#ae81ff>host</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./config/dnsmasq/dnsmasq.conf:/etc/dnsmasq.conf:ro</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># 以下是新增的配置。</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>wide-dhcpv6-client</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>cap_add</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>NET_ADMIN</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>wide-dhcpv6-client</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      <span style=color:#75715e># 这里的 INTERFACE 是连接外网的接口名称。</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>INTERFACE=ppp0</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>hoshinorei/wide-dhcpv6-client</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>network_mode</span>: <span style=color:#ae81ff>host</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./config/wide-dhcpv6-client/dhcp6c.conf:/etc/wide-dhcpv6/dhcp6c.conf:ro</span>
</span></span></code></pre></div><p>修改完成后，启动容器。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo docker-compose -f ~/docker-compose.yml up -d
</span></span></code></pre></div><p>不出意外的话，现在 LAN 口应该能获取到公网 IPv6 地址了。因为咱们前面已经将 Dnsmasq 设置好了，所以局域网的设备应该也能被分配公网 IPv6 地址。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>2: enp1s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
</span></span><span style=display:flex><span>    link/ether ██:██:██:██:██:██ brd ff:ff:ff:ff:ff:ff
</span></span><span style=display:flex><span>    inet 192.168.3.1/24 brd 192.168.3.255 scope global enp1s0
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>    inet6 240█:████:████:████::/64 scope global
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>    inet6 fe80::362f:579d:8c86:105b/64 scope link
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></div><p>你可以试试在内网 ping 外网的 IPv6 地址，在外网 ping 内网设备的公网 IPv6 地址。只要没被设备上的防火墙挡住，应该都是可以 ping 通的。</p><p>关于 PD 前缀还有一个问题，因为小玲这里的 PPPoE 连接偶尔会自己断一下，虽然 PPPoE 会自动重连，但是断开前获取的 PD 前缀会在重连后无法使用。所以咱们要写一个脚本，在 PPPoE 连接断开时自动删除已有的 PD 前缀，然后 PPPoE 连接成功后自动获取新的 PD 前缀。</p><p>在 <code>/etc/ppp/ipv6-down.d/</code> 文件夹下创建一个脚本，这个脚本小玲就命名为 <code>del_ipv6_pd_prefix</code>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo vim /etc/ppp/ipv6-down.d/del_ipv6_pd_prefix
</span></span></code></pre></div><p>写入以下内容。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e># 这里请替换成你的 LAN 口的接口名称。</span>
</span></span><span style=display:flex><span>INTERFACE<span style=color:#f92672>=</span>enp1s0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>IPV6_ADDRESS<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>ip a show dev $INTERFACE scope global | awk <span style=color:#e6db74>&#39;/inet6/{print $2}&#39;</span> | awk <span style=color:#e6db74>&#39;NR==1&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 这里判断 IPV6_ADDRESS 这个变量是否不为空，不为空则说明有 PD 前缀。</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> -n <span style=color:#e6db74>&#34;</span>$IPV6_ADDRESS<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># 不为空就把 PD 前缀删除。</span>
</span></span><span style=display:flex><span>  ip addr del $IPV6_ADDRESS dev $INTERFACE
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>exit <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>在 <code>/etc/ppp/ipv6-up.d/</code> 文件夹下创建一个脚本，这个脚本小玲就命名为 <code>restart_wide-dhcpv6-client</code>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo vim /etc/ppp/ipv6-up.d/restart_wide-dhcpv6-client
</span></span></code></pre></div><p>写入以下内容。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e># 这里的 docker-compose.yml 的路径请改成你自己的，请务必使用绝对路径。</span>
</span></span><span style=display:flex><span>docker-compose -f /home/hoshinorei/docker-compose.yml restart wide-dhcpv6-client
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>exit <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>写入脚本后，赋予它们执行权限。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo chmod +x /etc/ppp/ipv6-down.d/del_ipv6_pd_prefix /etc/ppp/ipv6-up.d/restart_wide-dhcpv6-client
</span></span></code></pre></div><p>理论上，现在就不会因为 PPPoE 连接重连后导致局域网内的设备无法使用 IPv6 了。</p><h2 id=upnp>UPnP
<a href=#upnp class=h-anchor aria-hidden=true>#</a></h2><p>咱们最好启用 UPnP 功能，这样电脑上如果有 BT 下载软件，通过 UPnP 映射了端口之后。与别人连接会更容易一点。咱们使用 miniupnpd 来提供 UPnP 服务。</p><p>创建一个文件夹来存放 miniupnpd 的配置文件。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p ~/config/miniupnpd
</span></span></code></pre></div><p>编写 <code>miniupnpd.conf</code>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vim ~/config/miniupnpd/miniupnpd.conf
</span></span></code></pre></div><p>写入以下内容。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span># 这三行配置的作用是检测路由器是否有公网 IP 或者在不受限制的 NAT 类型下面。
</span></span><span style=display:flex><span># 如果检测不通过 UPnP 就不会起作用。 
</span></span><span style=display:flex><span>ext_perform_stun=yes
</span></span><span style=display:flex><span>ext_stun_host=stun.stunprotocol.org
</span></span><span style=display:flex><span>ext_stun_port=3478
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># 使用系统时间而不是 miniupnpd 的运行时间。
</span></span><span style=display:flex><span>system_uptime=yes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># 这里的 UUID 请自己生成
</span></span><span style=display:flex><span>uuid=446cd1fe-9b0b-4527-8f2f-a58f2e7e5504
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># WAN 口的接口名称
</span></span><span style=display:flex><span>ext_ifname=ppp0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># 是否启用 UPnP
</span></span><span style=display:flex><span>enable_upnp=yes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># 是否启用 NAT-PMP
</span></span><span style=display:flex><span>enable_natpmp=yes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># LAN 口的接口名称
</span></span><span style=display:flex><span>listening_ip=enp1s0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># 这两行的配置的意思是只允许将路由器 WAN 口的 1024-65535 的端口映射到内网任意地址的 1024-65535 端口
</span></span><span style=display:flex><span>allow 1024-65535 0.0.0.0/0 1024-65535
</span></span><span style=display:flex><span>deny 0-65535 0.0.0.0/0 0-65535
</span></span></code></pre></div><p><code>allow</code> 的意思是允许哪些端口被映射，你也可以把 <code>allow</code> 改为 <code>deny</code> 来禁止哪些端口被映射。格式都是一样的。</p><p>第 1 个 <code>1024-65535</code> 是路由器本身也就是外网能访问的端口范围。</p><p>第 2 个 <code>1024-65535</code> 是内网的端口范围。</p><p><code>0.0.0.0/0</code> 是内网的 IPv4 网段，这里设成 <code>0.0.0.0/0</code> 指的是任意网段。</p><p>UUID 可以使用这个 <a href=https://www.uuidgenerator.net/version4>网站</a> 生成。</p><p>编辑 <code>docker-compose.yml</code> 文件，加入 miniupnpd 的配置。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#34;3&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>dnsmasq</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>dnsmasq</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>cap_add</span>: 
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>NET_ADMIN</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>hoshinorei/dnsmasq</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>network_mode</span>: <span style=color:#ae81ff>host</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./config/dnsmasq/dnsmasq.conf:/etc/dnsmasq.conf:ro</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>wide-dhcpv6-client</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>cap_add</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>NET_ADMIN</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>wide-dhcpv6-client</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>INTERFACE=ppp0</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>hoshinorei/wide-dhcpv6-client</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>network_mode</span>: <span style=color:#ae81ff>host</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./config/wide-dhcpv6-client/dhcp6c.conf:/etc/wide-dhcpv6/dhcp6c.conf:ro</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># 以下是新增的配置。</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>miniupnpd</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>cap_add</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>NET_ADMIN</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>miniupnpd</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>hoshinorei/miniupnpd</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>network_mode</span>: <span style=color:#ae81ff>host</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>tmpfs</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>/run</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./config/miniupnpd/miniupnpd.conf:/etc/miniupnpd/miniupnpd.conf:ro</span>
</span></span></code></pre></div><p>修改完成后，启动容器。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo docker-compose -f ~/docker-compose.yml up -d
</span></span></code></pre></div><h2 id=结尾>结尾
<a href=#%e7%bb%93%e5%b0%be class=h-anchor aria-hidden=true>#</a></h2><p>好了，你现在拥有了一个能正常上网的软路由啦。不过软路由的强大之处可不止这么点，小玲以后还会带来软路由的更多玩法。另外文章中出现的所有 Docker 镜像都已经开源在 <a href="https://github.com/HoshinoRei?tab=repositories&amp;q=docker&amp;type=&amp;language=&amp;sort=">Github</a>，可以放心使用。</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>来源：<a href=https://www.v2ex.com/t/724060>X86 软路由配置 IPv6 踩坑小记</a>。&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>阅读其它文章</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://blog.bling.moe/post/5/><span class=button__icon>←</span>
<span class=button__text>使用 Docker 搭建求生之路2的服务器</span></a></span>
<span class="button next"><a href=https://blog.bling.moe/post/2/><span class=button__text>Windows 上小狼毫输入法的上手教程</span>
<span class=button__icon>→</span></a></span></div></div><script src=https://giscus.app/client.js data-repo=HoshinoRei/blog data-repo-id=R_kgDOGZbNzw data-category=General data-category-id=DIC_kwDOGZbNz84CPgAu data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=1 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>星野玲的博客</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2025 Powered by <a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span><a href=https://github.com/panr/hugo-theme-hello-friend target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-E6TTBX28QL"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-E6TTBX28QL",{anonymize_ip:!1})}</script></body></html>